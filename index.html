<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é‡‘å¹£çˆ­å¥ªè³½</title>
    <style>
        /* CSS è®Šæ•¸ - äº®è‰²ä¸»é¡Œ */
        :root {
            --bg-gradient-start: #667eea;
            --bg-gradient-end: #764ba2;
            --container-bg: white;
            --text-primary: #333;
            --text-secondary: #555;
            --text-light: #666;
            --rules-bg: #f0f4ff;
            --section-bg: #f8f9fa;
            --row-selected-bg: #e3f2fd;
            --modal-bg: rgba(0,0,0,0.7);
            --coin-gradient-start: #ffd700;
            --coin-gradient-end: #ffed4e;
            --coin-border: #daa520;
            --switch-bg: #ccc;
            --switch-handle: white;
            --switch-icon: 'â˜€ï¸';

            --btn-primary-bg: white;
            --btn-primary-border: #667eea;
            --btn-primary-text: #667eea;
            --btn-primary-hover-bg: #667eea;
            --btn-primary-hover-text: white;

            --btn-success-bg: white;
            --btn-success-border: #4CAF50;
            --btn-success-text: #4CAF50;
            --btn-success-hover-bg: #4CAF50;
            --btn-success-hover-text: white;
            
            --btn-warning-bg: white;
            --btn-warning-border: #ff9800;
            --btn-warning-text: #ff9800;
            --btn-warning-hover-bg: #ff9800;
            --btn-warning-hover-text: white;

            --btn-disabled-bg: #ccc;
            --btn-disabled-text: #888;
            
            --player1-color: #667eea;
            --player2-color: #ff6b6b;
        }

        /* CSS è®Šæ•¸ - æš—è‰²ä¸»é¡Œ */
        body.dark-mode {
            --bg-gradient-start: #232526;
            --bg-gradient-end: #414345;
            --container-bg: #3b3b3b;
            --text-primary: #f0f0f0;
            --text-secondary: #dcdcdc; 
            --text-light: #b0b0b0;     
            --rules-bg: #4a4a4a;
            --section-bg: #2c2c2c;
            --row-selected-bg: #2a3947;
            --modal-bg: rgba(0,0,0,0.85);
            --coin-gradient-start: #ffb300;
            --coin-gradient-end: #ffcc4e;
            --coin-border: #ff8f00;
            --switch-bg: #2196F3;
            --switch-handle: white;
            --switch-icon: 'ğŸŒ™';

            --btn-primary-bg: #3b3b3b;
            --btn-primary-border: #899bff;
            --btn-primary-text: #899bff;
            --btn-primary-hover-bg: #899bff;
            --btn-primary-hover-text: #333;

            --btn-success-bg: #3b3b3b;
            --btn-success-border: #81c784;
            --btn-success-text: #81c784;
            --btn-success-hover-bg: #81c784;
            --btn-success-hover-text: #333;

            --btn-warning-bg: #3b3b3b;
            --btn-warning-border: #ffb74d;
            --btn-warning-text: #ffb74d;
            --btn-warning-hover-bg: #ffb74d;
            --btn-warning-hover-text: #333;

            --btn-disabled-bg: #555;
            --btn-disabled-text: #999;
            
            --player1-color: #899bff;
            --player2-color: #ff8787;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            transition: background 0.3s;
        }
        
        .game-container {
            background: var(--container-bg);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 600px;
            width: 100%;
            position: relative;
            transition: background 0.3s;
        }
        
        h1 {
            text-align: center;
            color: var(--text-primary);
            margin-bottom: 10px;
            font-size: 2.5em;
            transition: color 0.3s;
        }
        
        .rules {
            background: var(--rules-bg);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 0.9em;
            color: var(--text-secondary);
            transition: background 0.3s, color 0.3s;
        }
        
        .mode-selection {
            text-align: center;
            padding: 30px;
            background: var(--section-bg);
            border-radius: 15px;
            margin-bottom: 20px;
            transition: background 0.3s;
        }
        
        .mode-selection h2 {
            margin-bottom: 25px;
            color: var(--text-primary);
            font-size: 1.5em;
            transition: color 0.3s;
        }
        
        .mode-group {
            margin-bottom: 30px;
        }
        
        .mode-group h3 {
            margin-bottom: 15px;
            color: var(--text-secondary);
            font-size: 1.2em;
            transition: color 0.3s;
        }
        
        .mode-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        /* çµ±ä¸€æŒ‰éˆ•åŸºåº•æ¨£å¼ */
        .btn {
            padding: 15px 30px;
            font-size: 1.1em;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            min-width: 150px;
            border-width: 3px;
            border-style: solid;
            background-color: transparent; 
            text-align: center;
            text-decoration: none;
            display: inline-block;
        }
        .btn:hover:not(:disabled) {
            transform: scale(1.05);
        }
        .btn:disabled {
            background: var(--btn-disabled-bg) !important;
            color: var(--btn-disabled-text) !important;
            border-color: var(--btn-disabled-bg) !important;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }

        /* æŒ‰éˆ•é¡è‰² - ä¸»è¦ (è—) */
        .btn-primary {
            border-color: var(--btn-primary-border);
            color: var(--btn-primary-text);
            background-color: var(--btn-primary-bg);
        }
        .btn-primary:hover:not(:disabled) {
            background-color: var(--btn-primary-hover-bg);
            color: var(--btn-primary-hover-text);
        }
        .btn-primary.selected {
            background-color: var(--btn-primary-hover-bg);
            color: var(--btn-primary-hover-text);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        /* æŒ‰éˆ•é¡è‰² - æˆåŠŸ (ç¶ ) */
        .btn-success {
            border-color: var(--btn-success-border);
            color: var(--btn-success-text);
            background-color: var(--btn-success-bg);
        }
        .btn-success:hover:not(:disabled) {
            background-color: var(--btn-success-hover-bg);
            color: var(--btn-success-hover-text);
        }
        .start-game-btn-wrapper {
             margin-top: 20px;
        }

        /* æŒ‰éˆ•é¡è‰² - è­¦å‘Š (æ©˜) */
        .btn-warning {
            border-color: var(--btn-warning-border);
            color: var(--btn-warning-text);
            background-color: var(--btn-warning-bg);
        }
        .btn-warning:hover:not(:disabled) {
            background-color: var(--btn-warning-hover-bg);
            color: var(--btn-warning-hover-text);
        }
        
        .status {
            text-align: center;
            font-size: 1.3em;
            margin-bottom: 20px;
            color: var(--player1-color);
            font-weight: bold;
            min-height: 30px;
            transition: color 0.3s;
        }
        
        .coin-flip-container {
            text-align: center;
            padding: 30px;
            background: var(--section-bg);
            border-radius: 15px;
            margin-bottom: 20px;
            transition: background 0.3s;
        }
        
        .coin-flip-container h2 {
            margin-bottom: 20px;
            color: var(--text-primary);
            transition: color 0.3s;
        }
        
        .flip-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-bottom: 20px;
        }
        
        .flipping-coin {
            width: 100px;
            height: 100px;
            margin: 20px auto;
            background: linear-gradient(145deg, var(--coin-gradient-start), var(--coin-gradient-end));
            border: 4px solid var(--coin-border);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3em;
            animation: flip 0.6s ease-in-out;
            transition: background 0.3s, border 0.3s;
        }
        
        .flipping-coin.won {
            background: linear-gradient(145deg, #4caf50, #81c784); /* Green */
            border-color: #388e3c;
            color: white;
        }
        .flipping-coin.lost {
            background: linear-gradient(145deg, #f44336, #e57373); /* Red */
            border-color: #d32f2f;
            color: white;
        }
        
        @keyframes flip {
            0% { transform: rotateY(0); }
            100% { transform: rotateY(1800deg); }
        }
        
        .flip-result {
            font-size: 1.2em;
            color: var(--text-primary);
            margin-top: 15px;
            font-weight: bold;
            transition: color 0.3s;
        }
        
        .game-board {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .row {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: var(--section-bg);
            border-radius: 15px;
            transition: all 0.3s;
        }
        
        .row.selected {
            background: var(--row-selected-bg);
            box-shadow: 0 0 0 3px #2196F3;
        }
        
        .row-label {
            font-weight: bold;
            color: var(--text-secondary);
            min-width: 60px;
            transition: color 0.3s;
        }
        
        .coins {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .coin {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(145deg, var(--coin-gradient-start), var(--coin-gradient-end));
            border: 3px solid var(--coin-border);
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            position: relative;
        }
        
        .coin:hover {
            transform: translateY(-5px) scale(1.1);
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
        }
        
        .coin.selected {
            background: linear-gradient(145deg, #ff6b6b, #ff8787);
            border-color: #c92a2a;
            animation: pulse 0.5s infinite;
        }
        
        .coin.taken {
            opacity: 0;
            transform: scale(0);
            pointer-events: none;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .hidden {
            display: none;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--modal-bg);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal.show {
            display: flex;
        }
        
        .modal-content {
            background: var(--container-bg);
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            max-width: 400px;
            animation: slideIn 0.3s;
            transition: background 0.3s;
        }
        
        @keyframes slideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .modal h2 {
            font-size: 2em;
            margin-bottom: 20px;
            color: var(--text-primary);
            transition: color 0.3s;
        }
        
        .modal p {
            font-size: 1.2em;
            margin-bottom: 30px;
            color: var(--text-light);
            transition: color 0.3s;
        }
        
        .theme-switch-wrapper {
            position: absolute;
            top: 25px;
            right: 25px;
            display: flex;
            align-items: center;
        }
        .theme-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }
        .theme-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--switch-bg);
            transition: .4s;
        }
        .slider:before {
            position: absolute;
            content: var(--switch-icon);
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: var(--switch-handle);
            transition: .4s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
            line-height: 1;
        }
        input:checked + .slider {
            background-color: var(--switch-bg);
        }
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        .slider.round {
            border-radius: 34px;
        }
        .slider.round:before {
            border-radius: 50%;
        }

        .difficulty-badge {
            display: inline-block;
            background: #ff4757;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.8em;
            margin-left: 10px;
        }
        
        .difficulty-badge.easy {
            background: #4CAF50;
        }
    </style>
</head>
<body>
    <div class="game-container">
        <h1>ğŸ’° é‡‘å¹£çˆ­å¥ªè³½ ğŸ’°</h1>

        <div class="theme-switch-wrapper">
            <label class="theme-switch" for="theme-toggle">
                <input type="checkbox" id="theme-toggle" />
                <span class="slider round"></span>
            </label>
        </div>
        
        <div class="rules">
            <strong>éŠæˆ²è¦å‰‡ï¼š</strong><br>
            â€¢ æ¯æ¬¡åªèƒ½é¸æ“‡ä¸€æ’æ‹¿å–é‡‘å¹£<br>
            â€¢ å¯ä»¥æ‹¿å–è©²æ’çš„ä»»æ„æ•¸é‡ï¼ˆ1å€‹åˆ°å…¨éƒ¨ï¼‰<br>
            â€¢ æ‹¿åˆ°æœ€å¾Œä¸€å€‹é‡‘å¹£çš„äººå°±è¼¸äº†ï¼<br>
            â€¢ é»æ“Šé‡‘å¹£é¸æ“‡ï¼Œç„¶å¾ŒæŒ‰ç¢ºèªæ‹¿å–
        </div>
        
        <div id="modeSelection" class="mode-selection">
            <h2>âš™ï¸ é¸æ“‡éŠæˆ²æ¨¡å¼</h2>
            
            <div class="mode-group">
                <h3>å°æ‰‹é¸æ“‡ï¼š</h3>
                <div class="mode-buttons" id="opponent-buttons">
                    <button class="btn btn-primary selected" onclick="selectOpponent('ai')">ğŸ¤– å’Œ AI ç©</button>
                    <button class="btn btn-primary" onclick="selectOpponent('human')">ğŸ‘¥ å…©äººåŒæ©ŸéŠç©</button>
                </div>
            </div>
            
            <div class="mode-group">
                <h3>æ’æ•¸é¸æ“‡ï¼š</h3>
                <div class="mode-buttons" id="rows-buttons">
                    <button class="btn btn-primary" onclick="selectRows(3)">3ï¸âƒ£ ä¸‰æ’æ¨¡å¼</button>
                    <button class="btn btn-primary selected" onclick="selectRows(4)">4ï¸âƒ£ å››æ’æ¨¡å¼</button>
                </div>
            </div>
            
            <div class="start-game-btn-wrapper">
                <button class="btn btn-success" onclick="startGameSetup()">é–‹å§‹éŠæˆ² ğŸ®</button>
            </div>
        </div>
        
        <div id="coinFlipSection" class="coin-flip-container hidden">
            <h2>ğŸª™ çŒœç¡¬å¹£æ±ºå®šå…ˆå¾Œé †åº</h2>
            <p id="flipPrompt">è«‹é¸æ“‡æ­£é¢æˆ–åé¢ï¼š</p>
            <div class="flip-buttons">
                <button class="btn btn-primary" onclick="flipCoin('æ­£é¢')">æ­£é¢</button>
                <button class="btn btn-primary" onclick="flipCoin('åé¢')">åé¢</button>
            </div>
            <div id="flipResult"></div>
        </div>
        
        <div id="gameSection" class="hidden">
            <div class="status" id="status">æº–å‚™é–‹å§‹éŠæˆ²...</div>
            
            <div class="game-board" id="gameBoard"></div>
            
            <div class="controls">
                <button class="btn btn-success" id="confirmBtn" disabled>ç¢ºèªæ‹¿å–</button>
                <button class="btn btn-warning" id="resetBtn">é‡æ–°é–‹å§‹</button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="modal">
        <div class="modal-content">
            <h2 id="modalTitle"></h2>
            <p id="modalMessage"></p>
            <button class="btn btn-warning" onclick="resetGame()">å†ç©ä¸€æ¬¡</button>
        </div>
    </div>

    <script>
        let rows = [];
        let selectedRow = null;
        let selectedCoins = [];
        let isPlayerTurn = true;
        let gameOver = false;
        let gameStarted = false;
        let opponentType = 'ai'; // 'ai' or 'human'
        let numRows = 4; // 3 or 4
        let currentPlayer = 1; // 1 or 2 (for human vs human)

        function selectOpponent(type) {
            opponentType = type;
            document.querySelectorAll('#opponent-buttons .btn-primary').forEach(btn => {
                btn.classList.remove('selected');
                if (btn.textContent.includes(type === 'ai' ? 'AI' : 'å…©äºº')) {
                    btn.classList.add('selected');
                }
            });
        }

        function selectRows(num) {
            numRows = num;
            document.querySelectorAll('#rows-buttons .btn-primary').forEach(btn => {
                btn.classList.remove('selected');
                if (btn.textContent.includes(num + 'ï¸âƒ£')) {
                    btn.classList.add('selected');
                }
            });
        }

        function startGameSetup() {
            document.getElementById('modeSelection').classList.add('hidden');
            
            if (opponentType === 'human') {
                // [ä¿®æ”¹] å…©äººæ¨¡å¼ï¼šç›´æ¥é–‹å§‹ï¼Œä¸çŒœç¡¬å¹£
                currentPlayer = 1;
                document.getElementById('gameSection').classList.remove('hidden');
                gameStarted = true;
                initGame();
            } else {
                // AI æ¨¡å¼ï¼šçŒœç¡¬å¹£
                document.getElementById('coinFlipSection').classList.remove('hidden');
                document.getElementById('flipPrompt').textContent = 'è«‹é¸æ“‡æ­£é¢æˆ–åé¢ï¼š';
            }
        }

        function flipCoin(playerChoice) {
            // é€™å€‹å‡½å¼ç¾åœ¨åªæœƒåœ¨ AI æ¨¡å¼ä¸‹è¢«å‘¼å«
            const flipResult = document.getElementById('flipResult');
            flipResult.innerHTML = '<div class="flipping-coin">ğŸª™</div>';
            
            document.querySelectorAll('.flip-buttons .btn-primary').forEach(btn => btn.disabled = true);

            setTimeout(() => {
                const result = Math.random() < 0.5 ? 'æ­£é¢' : 'åé¢';
                const won = result === playerChoice;
                
                let resultText = '';
                let finalIcon = '';
                let iconClass = ''; 

                if (won) {
                    resultText = 'ä½ å…ˆæ‰‹ï¼ğŸ‰';
                    finalIcon = 'âœ”ï¸';
                    iconClass = 'won';
                } else {
                    resultText = 'AI å…ˆæ‰‹ï¼';
                    finalIcon = 'âŒ';
                    iconClass = 'lost';
                }
                isPlayerTurn = won;
                
                flipResult.innerHTML = `
                    <div class="flipping-coin ${iconClass}">${finalIcon}</div>
                    <div class="flip-result">
                        çµæœæ˜¯ï¼š${result}ï¼<br>
                        ${resultText}
                    </div>
                `;
                
                setTimeout(() => {
                    document.getElementById('coinFlipSection').classList.add('hidden');
                    document.getElementById('gameSection').classList.remove('hidden');
                    
                    document.querySelectorAll('.flip-buttons .btn-primary').forEach(btn => btn.disabled = false);

                    gameStarted = true;
                    initGame();
                    
                    if (opponentType === 'ai' && !isPlayerTurn) {
                        setTimeout(aiTurn, 1000);
                    }
                }, 2000);
            }, 700);
        }

        function initGame() {
            rows = numRows === 3 ? [1, 2, 3] : [1, 2, 3, 4];
            selectedRow = null;
            selectedCoins = [];
            gameOver = false;
            renderBoard();
            updateStatus();
            document.getElementById('modal').classList.remove('show');
        }

        function renderBoard() {
            const board = document.getElementById('gameBoard');
            board.innerHTML = '';
            
            rows.forEach((count, rowIndex) => {
                const rowDiv = document.createElement('div');
                rowDiv.className = 'row';
                rowDiv.id = `row-${rowIndex}`;
                
                const label = document.createElement('div');
                label.className = 'row-label';
                label.textContent = `ç¬¬${rowIndex + 1}æ’ï¼š`;
                rowDiv.appendChild(label);
                
                const coinsDiv = document.createElement('div');
                coinsDiv.className = 'coins';
                
                for (let i = 0; i < count; i++) {
                    const coin = document.createElement('div');
                    coin.className = 'coin';
                    coin.textContent = 'ğŸ’°';
                    coin.dataset.row = rowIndex;
                    coin.dataset.index = i;
                    coin.addEventListener('click', () => selectCoin(coin));
                    coinsDiv.appendChild(coin);
                }
                
                rowDiv.appendChild(coinsDiv);
                board.appendChild(rowDiv);
            });
        }

        function selectCoin(coinElement) {
            if (gameOver || coinElement.classList.contains('taken')) return;
            if (opponentType === 'ai' && !isPlayerTurn) return;

            const rowIndex = parseInt(coinElement.dataset.row, 10);
            
            if (selectedRow === null) {
                selectedRow = rowIndex;
            } else if (selectedRow !== rowIndex) {
                return;
            }
            
            coinElement.classList.toggle('selected');
            selectedCoins = document.querySelectorAll(`.coin[data-row="${selectedRow}"].selected`);
            
            if (selectedCoins.length === 0) {
                selectedRow = null;
                document.getElementById(`row-${rowIndex}`).classList.remove('selected');
            } else {
                document.getElementById(`row-${rowIndex}`).classList.add('selected');
            }
            
            updateStatus();
        }

        function confirmTake() {
            if (selectedCoins.length === 0 || selectedRow === null) return;
            
            rows[selectedRow] -= selectedCoins.length;
            
            selectedCoins.forEach(coin => {
                coin.classList.remove('selected');
                coin.classList.add('taken');
            });
            
            const currentRow = selectedRow;
            
            selectedCoins = [];
            selectedRow = null;
            document.getElementById(`row-${currentRow}`).classList.remove('selected');
            updateStatus(); 

            setTimeout(() => {
                if (checkGameOver()) {
                    if (opponentType === 'human') {
                        showModal(`ç©å®¶${currentPlayer} è¼¸äº†ï¼ğŸ˜¢`, `ç©å®¶${currentPlayer} æ‹¿åˆ°äº†æœ€å¾Œä¸€å€‹é‡‘å¹£ï¼`);
                    } else {
                        showModal('ä½ è¼¸äº†ï¼ğŸ˜¢', 'ä½ æ‹¿åˆ°äº†æœ€å¾Œä¸€å€‹é‡‘å¹£ï¼');
                    }
                    gameOver = true;
                    return;
                }
                
                if (opponentType === 'human') {
                    currentPlayer = currentPlayer === 1 ? 2 : 1;
                    updateStatus();
                } else {
                    isPlayerTurn = false;
                    updateStatus();
                    setTimeout(aiTurn, 1000);
                }
            }, 500); 
        }

        async function aiTurn() {
            if (gameOver) return;
            
            await new Promise(resolve => setTimeout(resolve, 750));
            
            const move = calculateOptimalMove();
            
            const rowCoins = document.querySelectorAll(`[data-row="${move.row}"]`);
            let coinsToTake = [];
            let takenCount = 0;
            
            for (let i = 0; i < rowCoins.length; i++) {
                if (!rowCoins[i].classList.contains('taken') && takenCount < move.count) {
                    rowCoins[i].classList.add('selected');
                    coinsToTake.push(rowCoins[i]);
                    takenCount++;
                }
            }

            await new Promise(resolve => setTimeout(resolve, 1000));

            rows[move.row] -= move.count;
            
            coinsToTake.forEach(coin => {
                coin.classList.remove('selected');
                coin.classList.add('taken');
            });
            
            setTimeout(() => {
                if (checkGameOver()) {
                    showModal('ä½ è´äº†ï¼ğŸ‰', 'AI æ‹¿åˆ°äº†æœ€å¾Œä¸€å€‹é‡‘å¹£ï¼');
                    gameOver = true;
                    return;
                }
                
                isPlayerTurn = true;
                updateStatus();
            }, 500);
        }

        function calculateOptimalMove() {
            let nimSum = 0;
            rows.forEach(count => {
                nimSum ^= count;
            });

            const nonZeroRows = rows.map((count, idx) => ({ count, idx }))
                                    .filter(r => r.count > 0);
            
            const nonZeroRowCount = nonZeroRows.length;
            const allRowsAreOnes = nonZeroRows.every(r => r.count === 1);
            
            let isWinningPosition;
            
            if (allRowsAreOnes) {
                isWinningPosition = (nonZeroRowCount % 2 !== 0);
            } else {
                isWinningPosition = (nimSum !== 0);
            }

            if (isWinningPosition) {
                for (let i = 0; i < rows.length; i++) {
                    if (rows[i] === 0) continue;

                    let targetCount = rows[i] ^ nimSum;
                    
                    if (targetCount < rows[i]) {
                        let otherRowsAreOnes = true;
                        for(let j = 0; j < rows.length; j++) {
                            if (i !== j && rows[j] > 1) {
                                otherRowsAreOnes = false;
                                break;
                            }
                        }
                        
                        if (otherRowsAreOnes && targetCount <= 1) {
                            const onesInOtherRows = nonZeroRows.filter(r => r.idx !== i && r.count === 1).length;
                            const onesAfterMove = onesInOtherRows + targetCount;
                            
                            if (onesAfterMove % 2 === 0) {
                                if (rows[i] > 1 && (rows[i] - targetCount) > 1) {
                                    return { row: i, count: (rows[i] - targetCount) - 1 };
                                }
                            }
                        }
                        
                        return { row: i, count: rows[i] - targetCount };
                    }
                }
            }

            let largeRow = nonZeroRows.find(r => r.count > 1);
            if (largeRow) {
                return { row: largeRow.idx, count: 1 };
            }
            
            return { row: nonZeroRows[0].idx, count: 1 };
        }

        function checkGameOver() {
            return rows.every(count => count === 0);
        }

        function updateStatus() {
            const status = document.getElementById('status');
            const confirmBtn = document.getElementById('confirmBtn');

            if (gameOver) return;

            if (opponentType === 'human') {
                status.textContent = `ç©å®¶${currentPlayer} çš„å›åˆ - è«‹é¸æ“‡é‡‘å¹£`;
                status.style.color = currentPlayer === 1 ? 'var(--player1-color)' : 'var(--player2-color)';
                confirmBtn.disabled = selectedCoins.length === 0;
            } else {
                if (isPlayerTurn) {
                    status.textContent = 'ä½ çš„å›åˆ - è«‹é¸æ“‡é‡‘å¹£';
                    status.style.color = 'var(--player1-color)';
                    confirmBtn.disabled = selectedCoins.length === 0;
                } else {
                    status.textContent = 'AI æ­£åœ¨æ€è€ƒ...';
                    status.style.color = 'var(--player2-color)';
                    confirmBtn.disabled = true; 
                }
            }
        }

        function showModal(title, message) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalMessage').textContent = message;
            document.getElementById('modal').classList.add('show');
        }

        function resetGame() {
            document.getElementById('modeSelection').classList.remove('hidden');
            document.getElementById('coinFlipSection').classList.add('hidden');
            document.getElementById('gameSection').classList.add('hidden');
            document.getElementById('flipResult').innerHTML = '';
            gameStarted = false;
            gameOver = false; 
            currentPlayer = 1;
            document.getElementById('modal').classList.remove('show');
            document.querySelectorAll('.flip-buttons .btn-primary').forEach(btn => btn.disabled = false);
        }

        // --- äº‹ä»¶ç›£è½ ---
        document.getElementById('confirmBtn').addEventListener('click', confirmTake);
        document.getElementById('resetBtn').addEventListener('click', resetGame);
        
        // --- ä¸»é¡Œåˆ‡æ›é‚è¼¯ ---
        const themeToggle = document.getElementById('theme-toggle');
        
        themeToggle.addEventListener('change', () => {
            document.body.classList.toggle('dark-mode');
            
            if (document.body.classList.contains('dark-mode')) {
                localStorage.setItem('theme', 'dark');
            } else {
                localStorage.setItem('theme', 'light');
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            if (localStorage.getItem('theme') === 'dark') {
                document.body.classList.add('dark-mode');
                themeToggle.checked = true;
            }
        });

    </script>
</body>
</html>